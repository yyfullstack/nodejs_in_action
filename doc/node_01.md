## node 基础

定义，“一个搭建在Chrome JavaScript 运行时上的平台，用于构建高速，可伸缩的网络程序。Node.js 采用的事件驱动、非阻塞I/O模型，使它既轻量又高效，并成为构建运行在分布式设备上的数据密集型实时程序的完美选择。”

#### 1.1 构建于javascript之上

现代化javascript虚拟机的性能正改变着可以构建在Web上的应用类型。一个很有说服力的、坦率地说是令人震惊的例子是jslinux，一个运行在javascript中的PC模拟器，它能加载Linux内核，可以利用终端会话与其交互，还能编译C程序，而这一切都是在浏览器中完成的。

Node 使用的是为Google Chrome 提供动力的V8虚拟机。V8让Node在性能上得到了巨大的提升，因为它去掉了中间环节，执行的不是字节码，用的也不是解释器，而是直接编译成本地机器码。Node在服务器端使用javascript还有其他好处。

- 开发人员用一种语言能编写整个web应用，这可以减少开发客户端和服务器端时所需的语言切换。这样代码可以在客户端和服务端共享，比如在表单校验或游戏逻辑中使用同一段代码。

- JSON是目前非常流行的数据交换格式，并且还是javascript原生的。

- 有些NoSQL数据库中用的就是javascript语言（如：CouchDB和MongoDB），所以跟它们简直是天作之合

- javascript是一门编译目标语言，现在有很多可以编译成javascript的语言

- Node用的虚拟机（V8) 会紧跟ECMAScript的标准。换句话说，在Node中如果想用新的的javascript语言特性，不用等到所有浏览器都支持。

#### 1.2 异步和事件触发：浏览器

	Node为服务端javascript提供了一个事件驱动、异步的平台。它把javascript带到服务器端中的方式跟浏览器吧javascript带到客户端的方式几乎一模一样。了解浏览器的工作原理对我们了解Node的工作原理会有很大帮助。它们都是事件驱动（用事件轮询）和非阻塞I/O处理（用异步I/O）

I/O操作（ajax请求）会“阻塞”脚本的继续执行，直到数据准备好，因为浏览器是单线程的，如果这个请求用了400ms才返回，那么页面上的其他任何事件都要等到那之后才能执行。可以想象一下，如果一副动画被停住了，或者用户试着跟页面交互时动不了，那种用户体验多糟糕。

当浏览器中有I/O操作是，该操作会在事件轮询的外面执行（脚本执行的主顺序之外），然后当这个I/O操作完成时，它会发出一个“事件”，会有一个函数（通常称为“回调”）处理它。

这个I/O是异步的，并不会“阻塞”脚本执行，事件轮询仍然可以响应页面上执行的其他交互或请求。这样，浏览器可以对客户做出响应，并且可以处理页面上的很多交互动作。

![1535003919575](H:\Node_workspace\nodejs_in_action\doc\1535003919575.png)

#### 1.3 异步和事件触发：服务器

	可能大多数人都了解传统的服务器编程的I/O模型，如PHP,

```
$result = mysql_query('select * from myTable');
print_r($result); //在数据库查询完成之前程序不会继续执行
```

这段代码做了些I/O操作，并且在所有数据回来之前，这个进程会被阻塞。对于很多程序而言，这个模型没什么问题，并且容易理解，但有一点可能会被忽略：这个进程也有状态，或者说内存空间，并且在I/O完成之前基本上什么也不会做。根据I/O操作的延迟情况，可能会有10ms到几分钟的时间。延迟可能由下列意外引发的：

- 硬盘正在执行维护操作，读/写都暂停了
- 因为负载增加，数据库查询变得更慢了
- 由于某种原因，今天从sitexyz.com拉取资源非常迟缓。

由于程序在I/O上阻塞了，当有更多请求过来时，服务器怎么处理呢？在这种情景中通常会用多线程的方式。一种常见的实现是给每个连接分配一个线程，并为那些连接设置一个线程池。你可以把线程想象成一个**计算工作区**，处理器在这个工作区中完成指定的任务。线程通常都是处于进程之内的，并且会维护它自己的工作内存。每个线程会处理一到多个服务器连接。尽管这听起来是个很自然的委派服务器劳动力的方式，但程序内的线程管理会非常复杂。此外，当需要大量的线程处理很多并发的服务器连接时，线程会消耗额外的操作系统资源。线程需要CPU和额外的RAM来做上下文切换。

为了说明这一点，我们来看Nginx和Apache的一个基准比较。Nginx跟Apache一样，是个http服务器，但它用的不是带有阻塞I/O的多线程方式，而是带有异步I/O的事件轮询（像浏览器和Node一样）。因为这些设计上选择，Nginx通常能处理更多的请求和客户端连接，它因此编程了响应能力更强的解决方案。

在Node中，I/O几乎总是在主事件轮询之外进行，使得服务器可以一直处在高效并且随时能够做出响应的状态，香Nginx一样，这样进程就更加不会受I/O限制，因为I/O延迟不会拖垮服务器，或者像在阻塞放射性那样占用很多资源。因此在一些服务器上曾经是重量级的操作，在Node的服务器上仍然可以是轻量级的。



#### 1.4 DIRT 程序

	实际上，Node所针对的应用程序有一个专门的简称：DIRT.它表示数据密集型实时（data-intensive real-time)程序，因为Node自身在I/O上非常轻量，它善于将数据从一个管道混排或代理到另一个管道上，这能在处理大量请求时持有很多开发的连接，并且只占用一小部分内存。它的设计目标是保证响应能力，跟浏览器一样。
	
	对Web来说，实时程序是一个新生事物。现在有很多web程序提供的信息几乎都是即时的，比如通过白板的在线协作、对公交车的实时精准定位、以及多人在线游戏。不管是用实时组件增强已有程序，还是打造全新的程序，Web都在朝着响应性和协作型环境逐渐进发。而这种新型的web应用程序需要一个能够实时响应大量并发用户的请求的平台来支撑它们。这正是Node所擅长的领域，并且不仅限于web程序，其他I/O负载比较重的程序也可以用到它。
	
	Browserling就是一个用Node开发的DIRT程序，它是一个很好啊范例。

![1535003879675](H:\Node_workspace\nodejs_in_action\doc\1535003879675.png)

#### 1.5 默认 DIRT

	Node从构建开始就有一个事件驱动和异步的模型。javascript从来没有过标准的I/O库，那是服务器语言的常见配置。对于javascript而言，这总是由“宿主” 环境决定的。javascript最常见的宿主环境，也是大多数开发人员所用的，那就是浏览器，它是事件驱动和异步的。
	
	Node重新实现了宿主中那些常用的对象，尽量让浏览器和服务器保持一致。Node还有一组用来处理多种网络和文件I/O的核心模块。其中包括用于HTTP、TLS、HTTPS、文件系统（POSIX）、数据报（UDP）和NET(TCP)的模块。这些核心模块刻意做的很小，底层并且坚定，只包含要给基于I/O的程序用的组成部分。第三方模块基于这些核心模块，针对常见的问题进行更高层的抽象。

##### 1.5.3 流数据

	Node 在数据流和数据流动上也很强大。你可以把**数据流看成特殊的数组**，只不过数组中的数据分散在空间上，而**数据流中的数据是分散在时间上的**。通过将数据一块一块地传送，开发人员可以每收到一块数据就开始处理，而不用等所有的数据全都到了再做处理。
	
	可读和可写数据流可以连接起来形成管道，就像shell脚本中用的|（管道）操作符一样。这是一种高效的数据处理方式，只有有数据准备好就可以处理，不用等着读取完整个资源再把它写出去。