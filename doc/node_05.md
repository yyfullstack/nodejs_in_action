## 存储Node程序中的数据

#### 5.1 无服务器的数据存储

##### 5.1.1 内存存储

内存存储的理想用途是存放少量经常使用的数据。用来跟踪记录最近一次重启服务器后页面访问次数的计数器就是这样的应用场景。

##### 5.1.2 基于文件的存储

基于文件的存储，用文件系统存放数据。开发人员经常用这种存储方式保存程序的配置信息，但你也可也用它做数据的持久化保存，这些数据在程序和服务器重启后依然有效。

**并发问题**

基于文件存储虽然易用，但并不是所有程序都适合。比如说，一个用户程序如果把记录保存在一个文件中，可能会碰到并发问题。两个用户可能会同时加载相同的文件进行修改。保存一个版本会覆盖另外一个，导致其中某个用户的修改丢失。对应多用户程序而言，数据管理系统是更合适的选择，因为它们就是为应对并问题而生的。

#### 5.2 关系型数据库管理系统

关系数据管理系统（RDBMS）可以存储复杂的信息，并且查询起来很容易。

##### 5.2.1 MySQL

MySQL 是最流行的的SQL 数据库，Node社区对它的支持很好。

##### 5.2.2 PostgreSQL

PostgreSQL因其与标准的兼容性和健壮性受到认可，很多Node开发人员对它的喜爱程度超过了其他的RDBMS.不像MySQL，PostgreSQL支持递归查询和很多特殊的数据类型。PostgreSQL还能使用一些标准的认证方法，比如轻量目录访问协议（LDAP）和通用安全服务应用程序接口（GSSAPI）。对于要借助数据复制实现扩展能力和冗余性的那些人来说，PostgreSQL支持同步复制，这种复制形态会在每次数据库操作后对复制进行验证，从而防止数据丢失。

#### 5.3 NoSQL数据库

在数据库世界刚具雏形之时，非关系型数据库才是标准。但关系数据库渐渐兴起，成为主流选择，在不在Web上的程序都会使用它。最近几年，非关系型DBMS隐隐有复兴之势，其支持者宣称它们在能力扩展和易用性上比关系型数据库有优势，并且这些DBMS可以应对多种应用场景。

尽管关系型DBMS为可靠性牺牲了性能，但很多NoSQL数据库吧性能放在了第一位，因此，对应实时分析或消息传递而言，NoSQL数据库可能是更好的选择。NoSQL数据库通常也不需要预先定义数据schema，对于那种要不数据存储在层次结构中，但层次结构却会发生变化的程序而言，这很有帮助。

##### 5.3.1 Redis

Redis非常适合处理那些不需要长期访问的简单数据存储，比如短信和游戏中的数据。Redis把数据存在**RAM**中，并在磁盘中记录数据的变化。这种做的缺点是它的存储空间有限，但好处是数据操作非常快。如果Redis服务器奔溃，RAM中的内容丢失，可以用磁盘中的日志恢复数据。

Redis 提供了实用的原语命令集，可以处理几种数据结构。Redis支持的大多数数据结构对开发人员来说并不陌生，因为它们都是仿造编程中常用的数据结构做的：哈希表、链表、键/值对。

哈希表，本质上是存放标识的表，这些标识被称为键，与相应的值关联。Redis命令hmset设定哈希表中的元素，用键标识值。hkeys列出哈希表中所有元素的键。

链表是Redis支持的另一种数据结构。如果内存足够大，Redis链表理论上可以存放40多亿条元素。Redis链表是有序的字符串链表。从概念上讲，Redis链表类似于很多编程语言中的数组，并且他们用的也是我们熟知的数据操作方法。然而链表的缺点在于从中获取数据的性能。随着链表长度的增长，数据获取也会逐渐变慢。

Redis集合是一组无序的字符串组。集合获取数据性能比链表好。它获取集合成员所有的时间取决于集合的大小（大o表示法中的o(1)).集合中的元素必须是唯一的，如果你试图把两个相同的值存到集合中，第二次尝试会被忽略。

Redis超越了数据存储的传统职责，它提供的信道是无价之宝。信道是数据传递机制，提供了发布/预定功能。Redis客户端可以向任一给定的信道预订或发布消息。预订一个信道意味着你会收到所有发送给它的消息。发布给信道的消息会发送给所有预订了那个信道的客户端。

![1535702708015](H:\Node_workspace\nodejs_in_action\doc\1535702708015.png)

在你准备吧使用了node_redis API的Node.js程序部署到生产环境中时，可能要考虑一下是否使用hiredis模块，这个模块会显著提升Redis的性能，因为它充分利用了官方的hiredis C语言库。如果你安装hiredis，node_redis API 会自动使用hiredis替代它的javascript实现。

##### 5.3.2 MongoDB

MongoDB 是一个通用的非关系型数据库，使用RDBMS的那类程序都可以使用MongoDB。MongoDB 数据库吧文档存在集合（collection）中。集合中的文档，它们不需要相同的schema，每个文档都可以有不同的schema。这使得MongoDB比传统的RDBMS更灵活。



